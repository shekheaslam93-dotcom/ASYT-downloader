<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0">
  <title>ASYT Downloader - Free YouTube Video Downloader</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Poppins', -apple-system, BlinkMacSystemFont, sans-serif;
      background-color: #f8fafc;
      color: #1e293b;
    }
    .progress-fill {
      background: linear-gradient(90deg, #3B82F6, #1E40AF);
      height: 100%;
      border-radius: 4px;
      transition: width 0.4s ease;
    }
    .btn-disabled {
      opacity: 0.7;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container mx-auto px-4 py-6 max-w-3xl">
    <!-- App Header -->
    <header class="flex justify-between items-center mb-8">
      <div class="flex items-center space-x-3">
        <div class="w-12 h-12 flex items-center justify-center rounded-full bg-gradient-to-r from-blue-500 to-purple-600">
          <i class="fas fa-cloud-download-alt text-white text-xl"></i>
        </div>
        <div>
          <h1 class="text-2xl font-bold">ASYT Downloader</h1>
          <p class="text-sm text-gray-500">by Aslam Sheikh</p>
        </div>
      </div>
    </header>

    <!-- Main Download Section -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-8">
      <div class="relative mb-6">
        <label for="youtubeUrl" class="sr-only">YouTube URL</label>
        <div class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
          <i class="fas fa-link text-gray-400"></i>
        </div>
        <input
          type="text"
          id="youtubeUrl"
          placeholder="Paste YouTube URL here..."
          class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          aria-label="YouTube URL"
          autocomplete="off"
        >
      </div>

      <!-- Options -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
        <div class="col-span-1">
          <label class="text-sm text-gray-600">Type</label>
          <select id="dlType" class="w-full border rounded-lg p-2">
            <option value="video">Video (.mp4)</option>
            <option value="audio">Audio (.mp3)</option>
          </select>
        </div>
        <div class="col-span-1 md:col-span-2">
          <label class="text-sm text-gray-600">Quality (video)</label>
          <select id="quality" class="w-full border rounded-lg p-2">
            <option value="best">Best Available</option>
            <option value="1080">1080p</option>
            <option value="720">720p</option>
            <option value="480">480p</option>
            <option value="360">360p</option>
          </select>
        </div>
      </div>

      <button
        id="downloadBtn"
        class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 rounded-lg transition-colors flex items-center justify-center"
        aria-label="Download">
        <i class="fas fa-download mr-2"></i> Download
      </button>
      <div id="errorMessage" class="text-red-500 text-sm mt-2 hidden" role="alert"></div>
    </div>

    <!-- Download Progress (basic visual only before redirect) -->
    <div id="downloadProgress" class="hidden bg-blue-50 rounded-lg p-4 mb-6">
      <div class="flex justify-between items-center mb-2">
        <span id="downloadTitle" class="font-medium">Preparing download...</span>
        <span id="downloadPercent" class="text-sm font-medium">0%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="progressBar" class="progress-fill" style="width: 0%"></div>
      </div>
      <div class="flex justify-between mt-2 text-xs text-gray-500">
        <span id="downloadSpeed">Speed: --</span>
        <span id="timeLeft">Time left: --:--</span>
      </div>
    </div>

    <!-- Features Section -->
    <div class="bg-white rounded-xl shadow-md p-6">
      <h3 class="font-bold text-lg mb-4">Free Features</h3>
      <ul class="space-y-3">
        <li class="flex items-start">
          <i class="fas fa-check text-blue-500 mr-2 mt-1"></i>
          <span>Download HD videos up to 1080p (auto-merge A/V)</span>
        </li>
        <li class="flex items-start">
          <i class="fas fa-check text-blue-500 mr-2 mt-1"></i>
          <span>Extract MP3 audio from videos</span>
        </li>
        <li class="flex items-start">
          <i class="fas fa-check text-blue-500 mr-2 mt-1"></i>
          <span>No registration required</span>
        </li>
        <li class="flex items-start">
          <i class="fas fa-check text-blue-500 mr-2 mt-1"></i>
          <span>Works on all devices</span>
        </li>
      </ul>
    </div>
  </div>

  <script>
    // DOM
    const downloadBtn   = document.getElementById('downloadBtn');
    const youtubeUrl    = document.getElementById('youtubeUrl');
    const downloadProgress = document.getElementById('downloadProgress');
    const progressBar   = document.getElementById('progressBar');
    const downloadPercent = document.getElementById('downloadPercent');
    const downloadTitle = document.getElementById('downloadTitle');
    const downloadSpeed = document.getElementById('downloadSpeed');
    const timeLeft      = document.getElementById('timeLeft');
    const errorMessage  = document.getElementById('errorMessage');
    const dlType        = document.getElementById('dlType');
    const qualitySel    = document.getElementById('quality');

    // Backend URL (local or your deployed URL on Render/Railway)
    // For local dev, leave empty to use same origin.
    const BACKEND_BASE = ""; // e.g. "https://asyt-backend.onrender.com"

    window.onload = () => youtubeUrl.focus();

    youtubeUrl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !downloadBtn.disabled) handleDownload();
    });
    downloadBtn.addEventListener('click', handleDownload);

    function isValidYT(url) {
      try {
        const u = url.toLowerCase();
        return (u.includes("youtube.com") || u.includes("youtu.be"));
      } catch {
        return false;
      }
    }

    async function handleDownload() {
      const url = youtubeUrl.value.trim();
      if (!url) {
        showError('Please enter a YouTube URL');
        return;
      }
      if (!isValidYT(url)) {
        showError('Please enter a valid YouTube URL');
        return;
      }

      // UI lock
      downloadBtn.disabled = true;
      downloadBtn.classList.add('btn-disabled');
      downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Preparing...';
      errorMessage.classList.add('hidden');

      // show simple progress animation (visual only)
      downloadProgress.classList.remove('hidden');
      animateFakeProgress();

      // Build endpoint
      const type = dlType.value; // "video" | "audio"
      const quality = qualitySel.value; // "best" or height
      const base = BACKEND_BASE || "";
      const endpoint = type === "audio"
        ? `${base}/download/audio?url=${encodeURIComponent(url)}`
        : `${base}/download/video?url=${encodeURIComponent(url)}&quality=${encodeURIComponent(quality)}`;

      // Trigger browser download by navigation (lets streaming start immediately)
      window.location.href = endpoint;

      // reset UI in a moment (user download dialog appears)
      setTimeout(() => {
        stopFakeProgress();
        downloadBtn.disabled = false;
        downloadBtn.classList.remove('btn-disabled');
        downloadBtn.innerHTML = '<i class="fas fa-download mr-2"></i> Download';
      }, 2000);
    }

    function showError(msg) {
      errorMessage.textContent = msg;
      errorMessage.classList.remove('hidden');
    }

    // Simple visual progress (pre-redirect only)
    let progInt = null, progVal = 0;
    function animateFakeProgress() {
      progVal = 0;
      progressBar.style.width = "0%";
      downloadPercent.textContent = "0%";
      downloadTitle.textContent = "Preparing download...";
      downloadSpeed.textContent = "Speed: --";
      timeLeft.textContent = "Time left: --:--";

      if (progInt) clearInterval(progInt);
      progInt = setInterval(() => {
        progVal = Math.min(progVal + Math.random() * 12, 95);
        progressBar.style.width = `${progVal}%`;
        downloadPercent.textContent = `${Math.round(progVal)}%`;
      }, 300);
    }
    function stopFakeProgress() {
      if (progInt) clearInterval(progInt);
      progressBar.style.width = "100%";
      downloadPercent.textContent = "100%";
      downloadTitle.textContent = "Starting download...";
      setTimeout(() => {
        downloadProgress.classList.add('hidden');
        progressBar.style.width = "0%";
        downloadPercent.textContent = "0%";
      }, 1500);
    }
  </script>
</body>
</html>
const express = require("express");
const cors = require("cors");
const morgan = require("morgan");
const ytdl = require("ytdl-core");
const sanitize = require("sanitize-filename");

const ffmpeg = require("fluent-ffmpeg");
const ffmpegPath = require("ffmpeg-static");
ffmpeg.setFfmpegPath(ffmpegPath);

const path = require("path");

const app = express();
app.use(cors());
app.use(morgan("dev"));
app.use(express.static("public")); // serve frontend

// small helper
function safeTitle(details) {
  const raw = details?.title || "asyt_video";
  return sanitize(raw).replace(/\s+/g, "_").substring(0, 120) || "asyt_video";
}

// ─────────────────────────────────────────────────────────────
// VIDEO DOWNLOAD (auto-merge if needed)
// GET /download/video?url=YOUTUBE_URL
// Optional: &quality=best|1080|720|480|360
// ─────────────────────────────────────────────────────────────
app.get("/download/video", async (req, res) => {
  try {
    const videoURL = req.query.url;
    const quality = (req.query.quality || "best").toLowerCase();

    if (!videoURL || !ytdl.validateURL(videoURL)) {
      return res.status(400).send("Invalid YouTube URL");
    }

    const info = await ytdl.getInfo(videoURL);
    const title = safeTitle(info.videoDetails);

    // choose quality
    let videoQuality = "highestvideo";
    if (["1080", "720", "480", "360"].includes(quality)) {
      // map to 'itag' selection with ytdl filter later via ffmpeg (we'll still pick best match)
      // We'll let ytdl pick closest by using qualityLabel filter below only when merging
      videoQuality = "highestvideo";
    }

    // Try combined video+audio first (progressive) to avoid merging when possible
    const progressiveFormat = ytdl
      .filterFormats(info.formats, "videoandaudio")
      .filter(f => f.container === "mp4")
      .sort((a, b) => (b.height || 0) - (a.height || 0))[0];

    const wantsProgressive =
      quality === "best" ||
      (progressiveFormat && ((progressiveFormat.height || 0) >= Number(quality)));

    if (progressiveFormat && wantsProgressive) {
      res.setHeader(
        "Content-Disposition",
        `attachment; filename="${title}.mp4"`
      );
      res.setHeader("Content-Type", "video/mp4");
      return ytdl(videoURL, {
        quality: "highest",
        filter: "videoandaudio",
        dlChunkSize: 0
      }).pipe(res);
    }

    // No good progressive? Merge separate video+audio with ffmpeg
    const videoStream = ytdl(videoURL, {
      quality: videoQuality,
      filter: format => format.hasVideo && !format.hasAudio
    });

    const audioStream = ytdl(videoURL, {
      quality: "highestaudio",
      filter: "audioonly",
      dlChunkSize: 0
    });

    res.setHeader(
      "Content-Disposition",
      `attachment; filename="${title}.mp4"`
    );
    res.setHeader("Content-Type", "video/mp4");

    // If user requested specific height (1080/720/480/360), hint ffmpeg to scale if source higher
    const height = Number(quality);
    const command = ffmpeg()
      .addInput(videoStream)
      .addInput(audioStream)
      .outputOptions([
        "-c:v libx264",
        "-c:a aac",
        "-movflags +faststart"
      ]);

    if ([1080, 720, 480, 360].includes(height)) {
      // scale keeping aspect ratio, pad if necessary
      command.videoFilters(`scale=-2:${height}`);
    }

    command.on("error", (err) => {
      console.error("FFmpeg error:", err.message);
      if (!res.headersSent) res.status(500).end("Failed to process video");
    });

    command.on("start", (cmd) => console.log("FFmpeg start:", cmd));
    command.on("end", () => console.log("FFmpeg finished"));

    command.format("mp4").pipe(res, { end: true });
  } catch (err) {
    console.error(err);
    res.status(500).send("Error downloading video");
  }
});

// ─────────────────────────────────────────────────────────────
// AUDIO DOWNLOAD (transcode to MP3 for compatibility)
// GET /download/audio?url=YOUTUBE_URL
// ─────────────────────────────────────────────────────────────
app.get("/download/audio", async (req, res) => {
  try {
    const videoURL = req.query.url;
    if (!videoURL || !ytdl.validateURL(videoURL)) {
      return res.status(400).send("Invalid YouTube URL");
    }

    const info = await ytdl.getInfo(videoURL);
    const title = safeTitle(info.videoDetails);

    res.setHeader(
      "Content-Disposition",
      `attachment; filename="${title}.mp3"`
    );
    res.setHeader("Content-Type", "audio/mpeg");

    const audioStream = ytdl(videoURL, {
      quality: "highestaudio",
      filter: "audioonly",
      dlChunkSize: 0
    });

    ffmpeg(audioStream)
      .audioCodec("libmp3lame")
      .audioBitrate(192)
      .format("mp3")
      .on("error", (err) => {
        console.error("FFmpeg error:", err.message);
        if (!res.headersSent) res.status(500).end("Failed to process audio");
      })
      .pipe(res, { end: true });
  } catch (err) {
    console.error(err);
    res.status(500).send("Error downloading audio");
  }
});

// ─────────────────────────────────────────────────────────────
const PORT = process.env.PORT || 3000;
app.listen(PORT, () =>
  console.log(`✅ Server running at http://localhost:${PORT}`)
);
